input {
    beats {
        # host => "0.0.0.0"
        port => 5044
    }
}

filter {
    # Suppression de la ligne d'entête
    if [decoded][csv][0] == "Nom" or [decoded][csv][0] == "0" {
        drop { }
    }

    # Supression des valeurs par défaut '0'
    alter {
        condrewrite => [
            "[decoded][csv][1]", "0", "",
            "[decoded][csv][2]", "0", "",
            "[decoded][csv][3]", "0", "",
            "[decoded][csv][4]", "0", "",
            "[decoded][csv][5]", "0", "",
            "[decoded][csv][6]", "0", "",
            "[decoded][csv][7]", "0", "",
            "[decoded][csv][8]", "0", "",
            "[decoded][csv][9]", "0", "",
            "[decoded][csv][10]", "0", "",
            "[decoded][csv][11]", "0", "",
            "[decoded][csv][12]", "0", "",
            "[decoded][csv][13]", "0", "",
            "[decoded][csv][14]", "0", "",
            "[decoded][csv][15]", "0", "",
            "[decoded][csv][16]", "0", "",
            "[decoded][csv][17]", "0", ""
        ]
    }
    
    mutate {

        add_field => { 
            "[project][name]" => "%{[decoded][csv][0]}"
            "[project][client]" => "%{[decoded][csv][1]}"
            "[project][creation_date]" => "%{[decoded][csv][2]}"
            "[project][created_by]" => "%{[decoded][csv][3]}"
            "[project][activity][tma]" => "%{[decoded][csv][4]}"
            "[project][activity][projects]" => "%{[decoded][csv][5]}"
            "[project][activity][total]" => "%{[decoded][csv][6]}"
            "[project][automation][future_plateform]" => "%{[decoded][csv][16]}"
         }
    }
    mutate {
        convert => {
          "[project][activity][tma]" => "integer"
          "[project][activity][projects]" => "integer"
          "[project][activity][total]" => "integer"
        }
    }

    fingerprint {
        source => ["[project][name]"]
        target => "fingerprint"
        key => "78787878"
        method => "SHA1"
        concatenate_sources => true
    }

    #
    # Structured datas
    #
   
    # Languages de développement
    ruby {
        path => "/usr/share/logstash/filters/list_technos.rb"
        script_params => {
            source => "[decoded][csv][7]"
            target => "[project][development][languages]"
        }
    }

    # Frameworks
    ruby {
        path => "/usr/share/logstash/filters/list_technos.rb"
        script_params => {
            source => "[decoded][csv][8]"
            target => "[project][development][frameworks]"
        }
    }

    # Middlewares
    ruby {
        path => "/usr/share/logstash/filters/list_technos.rb"
        script_params => {
            source => "[decoded][csv][9]"
            target => "[project][development][middlewares]"
        }
    }

    # Databases
    ruby {
        path => "/usr/share/logstash/filters/list_technos.rb"
        script_params => {
            source => "[decoded][csv][10]"
            target => "[project][development][databases]"
        }
    }

    # Others
    ruby {
        path => "/usr/share/logstash/filters/list_technos.rb"
        script_params => {
            source => "[decoded][csv][11]"
            target => "[project][development][others]"
        }
    }

    # Sources

    grok {
        match => { "[decoded][csv][12]" => "%{WORD:[project][development][sources][type]} \(%{WORD:[project][development][sources][owner]}\) : %{URI:[project][development][sources][link]}" }
        overwrite => [ "[project][development][sources]" ]
        tag_on_failure => [ "_sources_grokparsefailure"]
    }

    # CI-CD platform

    grok {
        match => { "[decoded][csv][13]" => "%{WORD:[project][automation][platform][type]} \(%{WORD:[project][automation][platform][owner]}\) : %{URI:[project][automation][platform][link]}" }
        overwrite => [ "[project][automation][platform]" ]
        tag_on_failure => [ "_automation_platform_grokparsefailure"]
    }

    # CI-CD steps

    mutate {
        split => {
                "[decoded][csv][14]" => ","
        }

        add_field => { 
           "[project][automation][steps]" => "%{[decoded][csv][14]}"
        }
        tag_on_failure =>  "_cicd_steps_mutate_error"
    }
    
    # Bundles
    mutate {
        split => {
                "[decoded][csv][15]" => ","
        }

        add_field => { 
            "[project][development][bundles]" => "%{[decoded][csv][15]}"
        }
        tag_on_failure =>  "_bundles_mutate_error"
    }
    
    # Environments
    ruby {
        path => "/usr/share/logstash/filters/list_envs.rb"
        script_params => {
            source => "[decoded][csv][17]"
            target => "[project][environments]"
            delimiter => "{EOL}"
        }
    }
}

output {
    elasticsearch {
        hosts => ["elasticsearch:9200"]
        index => "projets-datas"
        manage_template => true
        document_id => "%{fingerprint}"
        doc_as_upsert => true
    }
    stdout { codec => rubydebug }
}
